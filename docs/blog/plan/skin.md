---
title: 一种基于前端工程化的整站综合换肤方案
index: 1
---

~~*2021-06-15*~~ *2021-08-27*

## 背景

有时候需要网站能换肤, 嗯, 就酱

## 换肤方案

换肤有两种应用场景, 一种是构建时生成单个指定皮肤, 常见于“换皮项目”; 一种是运行时切换皮肤, 满足用户个性化需求

这里仅作简单介绍, 欢迎讨论、补充

### 构建时

即构建时生成指定皮肤, 主要面临的问题其实是项目管理方面的问题: 如何快速迭代满足甲方需求; 如何复用、同步各定制版本的功能; 如何避免版本/功能混乱、高耦合, 一个bug影响各个定制版本 等等

就换肤本身来说, 除了上述的问题外, 还存在因难以开发维护、难以自动化测试, 导致UI不稳定、风格不一致等问题

这里不展开讨论

### 运行时

即网站本身提供了多个版本, 甚至允许自定义皮肤, 用户可以按照自己的喜好切换皮肤.

这其中又分需要刷新网页的和不需要刷新的, 前者常见于网站为不同特征用户提供不同的功能和交互体验的场景, 比如: 老年版普通版青少年版 普通版极简版 设计师商家用户 等等; 后者比较常见, 比如: 浅色深色模式 各种主题等

具体实现方案大概有以下几种
<a id="fnref"><!-- 表格里的描回不来┓( ´∀` )┏ --></a>
| 方案 | 实现方式 | 优点 | 缺点
|--|--|--|--
| 配置文件 | 应用内根据配置项<ins title="可以与下面的方案结合">实现对应内容</ins> | 1. 样式和布局等都可配置<br>2. 允许用户自定义<br>3. 配置数据有移植潜力 | 1. 配置与应用强耦合, 配置项变更和管理成本较高
| [CSS变量](https://developer.mozilla.org/en-US/docs/Web/CSS/var())<sup><a href="#fn1">[1]</a></sup> | 通过修改CSS变量值实现换肤 | 1. 实现简单快速<br>2. 样式变量代码集中 | 1. 难以修改布局、动画等, 无法修改<ins title="canvas">js控制的样式</ins><br>2. 不兼容IE
| 样式覆盖 | <ins title="一般在根元素上增加class, 对应的样式都在这个class选择器下">利用CSS样式优先级覆盖默认样式</ins> | 1. 实现简单快速<br>2. 样式代码集中 | 1. 修改布局不够优雅, <ins title="略有影响性能">代码冗余</ins>, 无法修改<ins title="canvas">js控制的样式</ins><br>2. 需要良好的规范及代码组织, 否则<ins title="比如滥用!important内联样式等">维护成本高</ins><br>3. 难以<ins title="需要设计规范、保存用户的css">允许用户自定义</ins>
| [可替换样式表](https://developer.mozilla.org/docs/Web/CSS/Alternative_style_sheets)<sup><a href="#fn2">[2]</a></sup> | 通过可替换样式表来切换对应的样式文件 | 1. 样式<ins title="css可以完全不一样, 包括背景图、动画等等">自由度高</ins><br>2. 没有冗余代码, 整体<ins title="由浏览器来完整整个样式的切换">性能高</ins> | 1. 需要样式规范, 且无法修改<ins title="canvas">js控制的样式</ins><br>2. 难以<ins title="保存用户的css">允许用户自定义</ins><br>3. 增加打包时间和<ins title="但对浏览器的性能影响忽略不计, 因为可以先不加载或预加载, 切换的时候才会应用">体积</ins>
| [Vanilla JS](https://segmentfault.com/a/1190000000355277) | Vanilla JS :smirk: | 1. 自由度最高<br>2. 可配置且支持自定义<br>3. 支持canvas | 1. 开发维护成本高<br>2. 性能开销高 |

## 目标

TODO: 来个表格

1. 整站换肤
2. 易开发易维护降成本
  - 默认自动注入皮肤变量同时生成多套可运行时切换的皮肤
  - 支持异步chunk
  - css module / css object (`import STYLE from '*.scss'`) 支持
  - 细粒度特殊处理支持: 允许指定注入的变量 & 允许随皮肤切换样式和其他
  - 易于开发调试
3. 良好的扩展性 (用户定制)
4. 无缝(刷新)切换/懒加载/预加载/按需加载皮肤

## 实现思路

TODO: 来个表格

1. alternate stylesheet
2. scss/less... vars + webpack插件
  - loader 配置全局变量
  - runtime代码广播换肤事件(可自定义), 维护当前皮肤状态(全局变量, 可自定义)以待获取 (比如异步chunk)
  - 搜集构建信息, 根据当前皮肤提供接口更新css object(如使用vue reactivity劫持下 可做到比如维护一套变量控制包括echarts在内的皮肤及切换)
  - 提供接口, 构建时处理
  - 支持热更新, 但暂不支持开发环境切换皮肤(style标签, 支持成本大, 要么丢热更新, 要么改style标签内容, 这都可以做成另一种换肤方案了), 支持使用指定皮肤(命令行参数)启动开发环境
  - 暂不支持 css-in-js (styled-component 等)
3. 可支持 css var、在线打包、上传css
4. `<link rel="preload/prefetch"`

## 具体实现

TODO: api/规范 + 工程化

<!-- 没得办法, 只能人工脚注了┓( ´∀` )┏ -->
<hr>
1. 允许自定义css属性, 并在其作用域内的任何css中使用, 且修该自定义属性的值后, 使用该属性的样式会更新 <a href="#fnref" id="fn1">↩︎</a>

  ```css
  /* :root: 全局变量 */
  :root {
    /* 自定义属性必须以 -- 开头 */
    --main-bg-color: pink;
  }

  body {
    /* 变量无效(未定义/作用域...)时显示red */
    background-color: var(--main-bg-color, red);
  }
  ```

2. 它是 [HTML 4.01 规范](https://www.w3.org/TR/html401/present/styles.html#h-14.3) 中的内容, 允许切换网页使用的样式表, 切换样式方式如下 <a href="#fnref" id="fn2">↩︎</a>

  ```html

  ```
